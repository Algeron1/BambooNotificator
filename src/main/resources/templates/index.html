<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>RGS Bamboo Notifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .stand-card {
            border: none;
            border-radius: 1rem;
            background-color: #fff;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .stand-header {
            border-bottom: 3px solid #0d6efd;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-modern {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.75rem rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card-modern:hover {
            transform: translateY(-4px);
            box-shadow: 0 0.5rem 1.2rem rgba(0, 0, 0, 0.12);
        }

        .bg-success-custom {
            background-color: #d1e7dd !important;
        }

        .bg-error-custom {
            background-color: #f8d7da !important;
        }

        .bg-unknown-custom {
            background-color: #e2e3e5 !important;
        }

        .bg-in-progress-custom {
            background-color: #fff3cd !important;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.3em 0.7em;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .alert-ban {
            background-color: #fff8e1;
            color: #7c5700;
            border-left: 5px solid #ffc107;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .alert-ban:hover {
            background-color: #fff3cd;
        }

        .alert-ban button {
            background-color: #ffc107;
            border: none;
            color: #212529;
        }

        .alert-ban button:hover {
            background-color: #ffca2c;
        }
    </style>
</head>
<body class="p-4">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–µ–Ω–¥–æ–≤</h1>
        <button class="btn btn-success" onclick="alert('–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∞</button>
    </div>
    <h6 class="text-muted mb-4">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</h6>
    <div id="deploymentsList"></div>
</div>

<!-- Toast –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="toastContainer"></div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –±–∞–Ω–∞ -->
<div class="modal fade" id="banModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—Ä–æ—Å—å–±–∞ –Ω–µ –¥–µ–ø–ª–æ–∏—Ç—å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="banStandName">
                <div class="mb-3">
                    <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞</label>
                    <select class="form-select" id="banReasonSelect" onchange="handleReasonChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
                        <option value="–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –¥–µ–º–æ">–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –¥–µ–º–æ</option>
                        <option value="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –±–∞–≥–∞">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –±–∞–≥–∞</option>
                        <option value="–†–µ–≥—Ä–µ—Å—Å">–†–µ–≥—Ä–µ—Å—Å</option>
                        <option value="–ò–Ω–æ–µ">–ò–Ω–æ–µ</option>
                    </select>
                    <input type="text" class="form-control mt-2 d-none" id="banReasonCustom"
                           placeholder="–£–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é –ø—Ä–∏—á–∏–Ω—É">
                </div>
                <div class="mb-3">
                    <label class="form-label">–ê–≤—Ç–æ—Ä</label>
                    <input type="text" class="form-control" id="banAuthor">
                </div>
                <div class="mb-3">
                    <label class="form-label">–° (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</label>
                    <input type="datetime-local" class="form-control" id="banFrom">
                </div>
                <div class="mb-3">
                    <label class="form-label">–ü–æ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</label>
                    <input type="datetime-local" class="form-control" id="banTo">
                </div>
                <div class="mb-3">
                    <label class="form-label">–ü–∏–Ω-–∫–æ–¥ (4 —Ü–∏—Ñ—Ä—ã)</label>
                    <input type="password" class="form-control" id="banPinCode" maxlength="4"
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1234">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveBan()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Å–Ω—è—Ç–∏—è –±–∞–Ω–∞ -->
<div class="modal fade" id="removeBanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–í–≤–µ–¥–∏—Ç–µ –ø–∏–Ω-–∫–æ–¥ –¥–ª—è —Å–Ω—è—Ç–∏—è –±–∞–Ω–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="removeBanId">
                <input type="password" id="removeBanPinCode" maxlength="4" class="form-control" placeholder="4 —Ü–∏—Ñ—Ä—ã">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" onclick="confirmRemoveBan()">–°–Ω—è—Ç—å –∑–∞–ø—Ä–µ—Ç</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function fetchDeployments() {
        const response = await fetch('/deployments');
        const data = await response.json();
        const deployments = data.deployments;
        const deployBans = data.deployBans;

        const grouped = {};
        deployments.forEach(deploy => {
            const [stand, system] = deploy.environmentId.split("_");
            if (!grouped[stand]) grouped[stand] = [];
            grouped[stand].push({...deploy, system});
        });

        const container = document.getElementById('deploymentsList');
        container.innerHTML = '';

        for (const [standName, deploys] of Object.entries(grouped)) {
            const standCard = document.createElement('div');
            standCard.className = 'stand-card';

            const bans = deployBans.filter(b => b.standName === standName);
            let banBlock = '';

            if (bans.length > 0) {
                bans.forEach(ban => {
                    banBlock += `
        <div class="alert-ban mb-3">
          üö´ <strong>–ü—Ä–æ—Å—å–±–∞ –Ω–µ –¥–µ–ø–ª–æ–∏—Ç—å c ${new Date(ban.from).toLocaleString()} –¥–æ ${new Date(ban.to).toLocaleString()}</strong><br>
          üìå –ü—Ä–∏—á–∏–Ω–∞: <strong>${ban.reason}</strong><br>
          üë®‚Äçüíª –ê–≤—Ç–æ—Ä: <strong>${ban.author}</strong><br>
          <button class="btn btn-sm mt-2" onclick="openRemoveBanModal('${ban.id}')">–°–Ω—è—Ç—å –∑–∞–ø—Ä–µ—Ç</button>
        </div>`;
                });
            }


        standCard.innerHTML = `
        <div class="stand-header">
          <h3 class="mb-0">${standName}</h3>
          <button class="btn btn-primary btn-sm" onclick="openBanModal('${standName}')">–ü—Ä–æ—Å—å–±–∞ –Ω–µ –¥–µ–ø–ª–æ–∏—Ç—å</button>
        </div>
        ${banBlock}
        <div class="row gy-3"></div>
      `;

        const row = standCard.querySelector('.row');
        deploys.forEach(deploy => {
            let statusText = deploy.status;
            let statusClass = 'bg-unknown-custom';
            if (deploy.progressStatus === 'IN_PROGRESS') {
                statusText = '–ò–¥—ë—Ç –¥–µ–ø–ª–æ–π <span class="spinner-border spinner-border-sm ms-1"></span>';
                statusClass = 'bg-in-progress-custom';
            } else {
                if (deploy.status === 'SUCCESS') statusClass = 'bg-success-custom';
                if (deploy.status === 'ERROR') statusClass = 'bg-error-custom';
                if (deploy.status === 'UNKNOWN') statusClass = 'bg-unknown-custom';
            }

            const cardCol = document.createElement('div');
            cardCol.className = 'col-12 col-md-6 col-lg-4';
            cardCol.innerHTML = `
          <div class="card card-modern h-100 ${statusClass}">
            <div class="card-body">
              <h5 class="card-title">${deploy.system}</h5>
              <p><strong>–ë—Ä–∞–Ω—á:</strong> ${deploy.branchName}</p>
              <p><strong>–í–µ—Ä—Å–∏—è:</strong> ${deploy.deployVersion}</p>
              <p><strong>–ù–∞—á–∞–ª–æ:</strong> ${deploy.startedDate || '-'}</p>
              <p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:</strong> ${deploy.finishedDate || '-'}</p>
              <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${deploy.author || '-'}</p>
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge">${statusText}</span></p>
            </div>
          </div>
        `;
            row.appendChild(cardCol);
        });

        container.appendChild(standCard);
    }
    }

    function openBanModal(standName) {
        document.getElementById('banStandName').value = standName;
        new bootstrap.Modal(document.getElementById('banModal')).show();
    }

    async function saveBan() {
        const standName = document.getElementById('banStandName').value;
        const reasonSelect = document.getElementById('banReasonSelect').value;
        const customReason = document.getElementById('banReasonCustom').value;
        const author = document.getElementById('banAuthor').value;
        const from = document.getElementById('banFrom').value;
        const to = document.getElementById('banTo').value;
        const pinCode = document.getElementById('banPinCode').value;

        const reason = reasonSelect === '–ò–Ω–æ–µ' ? customReason : reasonSelect;

        if (!reason || !author || !from || !to || !/^\d{4}$/.test(pinCode)) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π 4-–∑–Ω–∞—á–Ω—ã–π –ø–∏–Ω-–∫–æ–¥");
            return;
        }

        await fetch('/deploy-ban', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({standName, reason, author, from, to, pinCode})
        });

        bootstrap.Modal.getInstance(document.getElementById('banModal')).hide();
        fetchDeployments();
    }

    function openRemoveBanModal(banId) {
        document.getElementById('removeBanId').value = banId;
        document.getElementById('removeBanPinCode').value = '';
        new bootstrap.Modal(document.getElementById('removeBanModal')).show();
    }

    async function confirmRemoveBan() {
        const banId = document.getElementById('removeBanId').value;
        const pinCode = document.getElementById('removeBanPinCode').value;

        if (!/^\d{4}$/.test(pinCode)) {
            showToast("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π 4-–∑–Ω–∞—á–Ω—ã–π –ø–∏–Ω-–∫–æ–¥", 'warning');
            return;
        }

        const response = await fetch(`/deploy-ban/${banId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pinCode})
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('removeBanModal')).hide();
            fetchDeployments();
            showToast("–ë–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å–Ω—è—Ç", 'success');
        } else {
            const error = await response.text();
            showToast(error || "–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è –±–∞–Ω–∞", 'danger');
        }
    }

    function showToast(message, type = 'danger') {
        const id = 'toast-' + Date.now();
        const toastHtml = `
      <div id="${id}" class="toast align-items-center text-white bg-${type} border-0 mb-2" role="alert">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;
        document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHtml);
        new bootstrap.Toast(document.getElementById(id), {delay: 4000}).show();
    }

    function handleReasonChange() {
        const select = document.getElementById('banReasonSelect');
        const customInput = document.getElementById('banReasonCustom');
        if (select.value === '–ò–Ω–æ–µ') {
            customInput.classList.remove('d-none');
            customInput.focus();
        } else {
            customInput.classList.add('d-none');
            customInput.value = '';
        }
    }

    fetchDeployments();
    setInterval(fetchDeployments, 30000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
