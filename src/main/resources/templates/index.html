<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>RGS Bamboo Notifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-success {
            color: #198754;
            font-weight: bold;
        }
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        .status-in-progress {
            color: #ffc107;
            font-weight: bold;
        }
        .status-unknown {
            color: #6c757d;
            font-weight: bold;
        }

        .bg-success-custom {
            background-color: #d1e7dd !important;
        }
        .bg-unknown-custom {
            background-color: #dee2e6 !important;
        }
    </style>
</head>
<body class="p-4">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ç–µ–Ω–¥–æ–≤</h1>
        <button class="btn btn-success" onclick="alert('–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∞</button>
    </div>
    <h5 class="mb-0">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</h5>

    <div id="deploymentsList" class="gy-3"></div>
</div>

<script>
    async function fetchDeployments() {
        const response = await fetch('/deployments');
        const deployments = await response.json();

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç–µ–Ω–¥—É
        const grouped = {};
        deployments.forEach(deploy => {
            const [stand, system] = deploy.environmentId.split("_");
            if (!grouped[stand]) grouped[stand] = [];
            grouped[stand].push({...deploy, system});
        });

        const container = document.getElementById('deploymentsList');
        container.innerHTML = '';

        for (const [standName, deploys] of Object.entries(grouped)) {
            const standBlock = document.createElement('div');
            standBlock.className = 'mb-5';

            standBlock.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">${standName}</h3>
                    <button class="btn btn-primary" onclick="alert('–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">–ü—Ä–æ—Å—å–±–∞ –Ω–µ –¥–µ–ø–ª–æ–∏—Ç—å</button>
                </div>
            `;

            deploys.forEach(deploy => {
                const statusClass = {
                    'SUCCESS': 'status-success',
                    'ERROR': 'status-error',
                    'IN_PROGRESS': 'status-in-progress',
                    'UNKNOWN': 'status-unknown'
                }[deploy.status] || 'status-unknown';

                let bgClass = '';
                if (deploy.status === 'SUCCESS') bgClass = 'bg-success-custom';
                if (deploy.status === 'UNKNOWN') bgClass = 'bg-unknown-custom';

                const card = document.createElement('div');
                card.className = `card shadow-sm mb-3 ${bgClass}`;

                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${deploy.system}</h5>
                        <p class="mb-1">üåø –ë—Ä–∞–Ω—á: <strong>${deploy.branchName}</strong></p>
                        <p class="mb-1">üì¶ –í–µ—Ä—Å–∏—è: <strong>${deploy.deployVersion}</strong></p>
                        <p class="mb-1">üïì –ù–∞—á–∞–ª–æ: ${deploy.startedDate || '-'}</p>
                        <p class="mb-1">üïî –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: ${deploy.finishedDate || '-'}</p>
                        <p class="mb-1">üë®‚Äçüíª –ê–≤—Ç–æ—Ä: ${deploy.author || '-'}</p>
                        <p class="mb-0">üìä –°—Ç–∞—Ç—É—Å: <span class="${statusClass}">${deploy.status}</span></p>
                    </div>
                `;
                standBlock.appendChild(card);
            });

            container.appendChild(standBlock);
        }
    }

    fetchDeployments();
    setInterval(fetchDeployments, 30000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
