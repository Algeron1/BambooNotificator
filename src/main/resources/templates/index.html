<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>RGS Bamboo Notifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-success {
            color: #198754;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        .status-in-progress {
            color: #ffc107;
            font-weight: bold;
        }

        .status-unknown {
            color: #6c757d;
            font-weight: bold;
        }

        .bg-success-custom {
            background-color: #d1e7dd !important;
        }

        .bg-unknown-custom {
            background-color: #dee2e6 !important;
        }
    </style>
</head>
<body class="p-4">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ç–µ–Ω–¥–æ–≤</h1>
        <button class="btn btn-success" onclick="alert('–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∞</button>
    </div>
    <h5 class="mb-0">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</h5>

    <div id="deploymentsList" class="gy-3"></div>
    <div class="container">
        <!-- –§—É—Ç–µ—Ä —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ -->
        <footer class="mt-5 pt-4 pb-2 border-top text-center text-muted">
            <p class="mb-1">–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Å–æ–∑–¥–∞—Ç–µ–ª—é:</p>
            <div class="d-flex justify-content-center gap-3">
                <a href="https://t.me/el_eduardo" target="_blank" class="text-decoration-none">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg"
                         alt="Telegram" width="24" height="24"> Telegram
                </a>
                <a href="https://vk.com/id13450731" target="_blank" class="text-decoration-none">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/2/21/VK.com-logo.svg"
                         alt="VK" width="24" height="24"> –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
                </a>
            </div>
        </footer>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–Ω–∞ -->
<div class="modal fade" id="banModal" tabindex="-1" aria-labelledby="banModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω –Ω–∞ –¥–µ–ø–ª–æ–π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="banStandName">
                <div class="mb-3">
                    <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞</label>
                    <select class="form-select" id="banReasonSelect" onchange="handleReasonChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
                        <option value="–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –¥–µ–º–æ">–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –¥–µ–º–æ</option>
                        <option value="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –±–∞–≥–∞">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –±–∞–≥–∞</option>
                        <option value="–†–µ–≥—Ä–µ—Å—Å">–†–µ–≥—Ä–µ—Å—Å</option>
                        <option value="–ò–Ω–æ–µ">–ò–Ω–æ–µ</option>
                    </select>
                    <input type="text" class="form-control mt-2 d-none" id="banReasonCustom"
                           placeholder="–£–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é –ø—Ä–∏—á–∏–Ω—É">
                </div>
                <div class="mb-3">
                    <label class="form-label">–ê–≤—Ç–æ—Ä</label>
                    <input type="text" class="form-control" id="banAuthor">
                </div>
                <div class="mb-3">
                    <label class="form-label">–°</label>
                    <input type="datetime-local" class="form-control" id="banFrom">
                </div>
                <div class="mb-3">
                    <label class="form-label">–ü–æ</label>
                    <input type="datetime-local" class="form-control" id="banTo">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveBan()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function fetchDeployments() {
        const response = await fetch('/deployments');
        const data = await response.json();
        const deployments = data.deployments;
        const deployBans = data.deployBans;

        const grouped = {};
        deployments.forEach(deploy => {
            const [stand, system] = deploy.environmentId.split("_");
            if (!grouped[stand]) grouped[stand] = [];
            grouped[stand].push({...deploy, system});
        });

        const container = document.getElementById('deploymentsList');
        container.innerHTML = '';

        for (const [standName, deploys] of Object.entries(grouped)) {
            const standBlock = document.createElement('div');
            standBlock.className = 'mb-5';

            const ban = deployBans.find(b => b.standName === standName);
            let banBlock = '';
            if (ban) {
                banBlock = `
                    <div class="alert alert-danger mb-3">
                        üö´ –î–µ–ø–ª–æ–π –∑–∞–ø—Ä–µ—â—ë–Ω —Å ${new Date(ban.from).toLocaleString()} –¥–æ ${new Date(ban.to).toLocaleString()}<br>
                        <strong>${ban.reason}</strong> (–∞–≤—Ç–æ—Ä: ${ban.author})<br>
                        <button class="btn btn-sm btn-outline-light mt-2" onclick="removeBan('${standName}')">–°–Ω—è—Ç—å –±–∞–Ω</button>
                    </div>
                `;
            }

            standBlock.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">${standName}</h3>
                    <button class="btn btn-primary" onclick="openBanModal('${standName}')">–ü—Ä–æ—Å—å–±–∞ –Ω–µ –¥–µ–ø–ª–æ–∏—Ç—å</button>
                </div>
                ${banBlock}
            `;

            deploys.forEach(deploy => {
                const statusClass = {
                    'SUCCESS': 'status-success',
                    'ERROR': 'status-error',
                    'IN_PROGRESS': 'status-in-progress',
                    'UNKNOWN': 'status-unknown'
                }[deploy.status] || 'status-unknown';

                let bgClass = '';
                if (deploy.status === 'SUCCESS') bgClass = 'bg-success-custom';
                if (deploy.status === 'UNKNOWN') bgClass = 'bg-unknown-custom';

                const card = document.createElement('div');
                card.className = `card shadow-sm mb-3 ${bgClass}`;
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${deploy.system}</h5>
                        <p class="mb-1">üåø –ë—Ä–∞–Ω—á: <strong>${deploy.branchName}</strong></p>
                        <p class="mb-1">üì¶ –í–µ—Ä—Å–∏—è: <strong>${deploy.deployVersion}</strong></p>
                        <p class="mb-1">üïì –ù–∞—á–∞–ª–æ: ${deploy.startedDate || '-'}</p>
                        <p class="mb-1">üïî –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: ${deploy.finishedDate || '-'}</p>
                        <p class="mb-1">üë®‚Äçüíª –ê–≤—Ç–æ—Ä: ${deploy.author || '-'}</p>
                        <p class="mb-0">üìä –°—Ç–∞—Ç—É—Å: <span class="${statusClass}">${deploy.status}</span></p>
                    </div>
                `;
                standBlock.appendChild(card);
            });

            container.appendChild(standBlock);
        }
    }

    function openBanModal(standName) {
        document.getElementById('banStandName').value = standName;
        const modal = new bootstrap.Modal(document.getElementById('banModal'));
        modal.show();
    }

    async function saveBan() {
        const standName = document.getElementById('banStandName').value;
        const reasonSelect = document.getElementById('banReasonSelect').value;
        const customReason = document.getElementById('banReasonCustom').value;
        const author = document.getElementById('banAuthor').value;
        const from = document.getElementById('banFrom').value;
        const to = document.getElementById('banTo').value;

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é –ø—Ä–∏—á–∏–Ω—É
        const reason = reasonSelect === '–ò–Ω–æ–µ' ? customReason : reasonSelect;

        if (!reason || !author || !from || !to) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!");
            return;
        }

        await fetch('/deploy-ban', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ standName, reason, author, from, to })
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('banModal'));
        modal.hide();
        fetchDeployments();
    }

    async function removeBan(standName) {
        if (!confirm(`–°–Ω—è—Ç—å –±–∞–Ω —Å–æ —Å—Ç–µ–Ω–¥–∞ ${standName}?`)) return;

        await fetch(`/deploy-ban/${standName}`, {method: 'DELETE'});
        fetchDeployments();
    }

    function handleReasonChange() {
        const select = document.getElementById('banReasonSelect');
        const customInput = document.getElementById('banReasonCustom');

        if (select.value === '–ò–Ω–æ–µ') {
            customInput.classList.remove('d-none');
            customInput.focus();
        } else {
            customInput.classList.add('d-none');
            customInput.value = '';
        }
    }

    fetchDeployments();
    setInterval(fetchDeployments, 30000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
