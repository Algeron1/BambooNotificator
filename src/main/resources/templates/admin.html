<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>RGS Bamboo Notifier ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .stand-card {
            border: none;
            border-radius: 1rem;
            background-color: #fff;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .btn-modern {
            border-radius: 0.5rem;
        }

        .footer {
            margin-top: 5rem;
            text-align: center;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .announcement-card {
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #212529;
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.05);
            border-left: 5px solid;
        }

        .announcement-info {
            background-color: #e9f7ef;
            border-color: #198754;
        }

        .announcement-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
        }

        .announcement-critical {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="p-4">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <button class="btn btn-outline-danger btn-modern" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>

    <div class="stand-card mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">üì¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h4>
            <button class="btn btn-sm btn-outline-secondary" onclick="fetchAnnouncements()">
                –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
        <div id="currentAnnouncements" class="mt-3">
            <div class="text-center">
                <span class="loading-spinner"></span> –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ -->
    <div class="stand-card">
        <h4 class="mb-3">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª—ã</h4>
        <div class="mb-3">
            <label class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea id="textMessage" class="form-control" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        </div>
        <button class="btn btn-primary btn-modern" onclick="sendText()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <div id="resultMessage" class="mt-3"></div>
    </div>

    <!-- –ë–ª–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
    <div class="stand-card">
        <h4 class="mb-3">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h4>
        <div class="mb-3">
            <label class="form-label">–ê–≤—Ç–æ—Ä</label>
            <input type="text" id="announcementAuthor" class="form-control" placeholder="–í–∞—à–µ –∏–º—è">
        </div>
        <div class="mb-3">
            <label class="form-label">–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è</label>
            <textarea id="announcementText" class="form-control" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">–£—Ä–æ–≤–µ–Ω—å –≤–∞–∂–Ω–æ—Å—Ç–∏</label>
            <select id="announcementLevel" class="form-select" onchange="updateLevelStyle(this)">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å</option>
                <option value="INFO" style="background-color: #e9f7ef;">–ò–Ω—Ñ–æ</option>
                <option value="WARNING" style="background-color: #fff3cd;">–í–Ω–∏–º–∞–Ω–∏–µ</option>
                <option value="CRITICAL" style="background-color: #f8d7da;">–ö—Ä–∏—Ç–∏—á–Ω–æ</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ —Å—É—Ç–∫–∏)</label>
            <input type="datetime-local" id="announcementExpires" class="form-control">
        </div>
        <button class="btn btn-primary btn-modern" onclick="sendAnnouncement()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        <div id="resultAnnouncement" class="mt-3"></div>
    </div>

    <div class="stand-card mb-4">
        <h4 class="mb-3">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏</h4>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="settingTelegram" onchange="changeSettings()">
            <label class="form-check-label" for="settingTelegram">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</label>
        </div>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="settingPachka" onchange="changeSettings()">
            <label class="form-check-label" for="settingPachka">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ü–∞—á–∫—É</label>
        </div>
    </div>
</div>

<footer class="footer">
    <hr>
    <p>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ ‚Äî –≠–¥—É–∞—Ä–¥ –Ø–¥–∏–≥–∞—Ä–æ–≤</p>
    <p>
        üìß <a href="mailto:eduard_yadigarov@rgs.ru">–ü–æ—á—Ç–∞</a> |
        üí¨ <a href="https://t.me/el_eduardo" target="_blank">Telegram</a> |
        üí¨ <a href="https://vk.com/id13450731" target="_blank">VK</a>
        üí¨ <a href="https://t.me/+U-qA4hKIGVk2ODcy" target="_blank"><strong>–ö–∞–Ω–∞–ª Telegram</strong></a>
        üí¨ <a href="https://app.pachca.com/chats/26092493" target="_blank"><strong>–ö–∞–Ω–∞–ª –ü–∞—á–∫–∞</strong></a>
    </p>
</footer>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="toastContainer"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', fetchAnnouncements);
    async function fetchAnnouncements() {
        try {
            const response = await fetch('/admin/announcements');
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π');

            const announcements = await response.json();
            renderAnnouncements(announcements);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('currentAnnouncements').innerHTML =
                '<div class="alert alert-warning">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è</div>';
        }
    }

    function updateLevelStyle(select) {
        const value = select.value;
        select.classList.remove('bg-success', 'bg-warning', 'bg-danger');

        if (value === 'INFO') select.classList.add('bg-success', 'text-white');
        else if (value === 'WARNING') select.classList.add('bg-warning');
        else if (value === 'CRITICAL') select.classList.add('bg-danger', 'text-white');
        else select.className = 'form-select'; // —Å–±—Ä–æ—Å —Ü–≤–µ—Ç–∞ –µ—Å–ª–∏ –ø—É—Å—Ç–æ
    }

    function renderAnnouncements(announcements) {
        const container = document.getElementById('currentAnnouncements');

        if (!announcements || announcements.length === 0) {
            container.innerHTML = '<div class="alert alert-info">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>';
            return;
        }

        let html = '';
        announcements.forEach(ann => {
            let levelClass = 'announcement-info';
            if (ann.warningLevel === 'WARNING') levelClass = 'announcement-warning';
            if (ann.warningLevel === 'CRITICAL') levelClass = 'announcement-critical';

            const expiresDate = formatDateTime(ann.to);
            const createdDate = formatDateTime(ann.from);

            html += `
    <div class="announcement-card ${levelClass} mb-3">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="d-flex justify-content-between">
                    <strong>${ann.author}</strong>
                    <small>${createdDate}</small>
                </div>
                <div class="mt-2 mb-2">${ann.text}</div>
                <div class="text-muted small">
                    <div>–£—Ä–æ–≤–µ–Ω—å: ${getLevelName(ann.warningLevel)}</div>
                    <div>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${expiresDate}</div>
                </div>
            </div>
            <button class="btn btn-sm btn-outline-danger ms-2"
                    onclick="deleteAnnouncement('${ann.id}')"
                    title="–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ">
                üóëÔ∏è
            </button>
        </div>
    </div>
    `;
        });
        container.innerHTML = html;
    }

    async function deleteAnnouncement(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) {
            return;
        }

        try {
            const response = await fetch(`/admin/announcement/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
                await fetchAnnouncements();
            } else {
                const errorText = await response.text();
                showToast(`–û—à–∏–±–∫–∞: ${errorText}`, 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', 'danger');
        }
    }

    function getLevelName(level) {
        switch (level) {
            case 'INFO':
                return '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π';
            case 'WARNING':
                return '–í–∞–∂–Ω–æ–µ';
            case 'CRITICAL':
                return '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ';
            default:
                return level;
        }
    }

    async function sendText() {
        const message = document.getElementById('textMessage').value;
        const result = document.getElementById('resultMessage');

        if (!message.trim()) {
            result.innerHTML = '<div class="text-danger">–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.</div>';
            return;
        }

        const response = await fetch('admin/sendText', {
            method: 'POST',
            headers: {'Content-Type': 'text/plain'},
            body: message
        });

        if (response.ok) {
            result.innerHTML = '<div class="text-success">–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.</div>';
            document.getElementById('textMessage').value = '';
        } else {
            const errorText = await response.text();
            result.innerHTML = `<div class="text-danger">–û—à–∏–±–∫–∞: ${errorText}</div>`;
        }
    }

    async function sendAnnouncement() {
        const text = document.getElementById('announcementText').value.trim();
        const author = document.getElementById('announcementAuthor').value.trim();
        const level = document.getElementById('announcementLevel').value;
        const expires = document.getElementById('announcementExpires').value;
        const result = document.getElementById('resultAnnouncement');

        if (!text || !author || !level) {
            result.innerHTML = '<div class="text-danger">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è.</div>';
            return;
        }

        const response = await fetch('/admin/announcement', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                text,
                author,
                warningLevel: level,
                to: expires
            })
        });

        if (response.ok) {
            result.innerHTML = '<div class="text-success">–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ.</div>';
            document.getElementById('announcementText').value = '';
            document.getElementById('announcementAuthor').value = '';
            document.getElementById('announcementLevel').value = '';
            document.getElementById('announcementExpires').value = '';

            await fetchAnnouncements();
        } else {
            const errorText = await response.text();
            result.innerHTML = `<div class="text-danger">–û—à–∏–±–∫–∞: ${errorText}</div>`;
        }
    }
    loadCurrentSettings();

    function formatDateTime(dateString) {
        if (!dateString) return '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
        const date = new Date(dateString);
        return date.toLocaleString('ru-RU');
    }

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();

        const toastHTML = `
            <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body bg-${type} text-white">
                    ${message}
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        setTimeout(() => {
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                toastElement.remove();
            }
        }, 5000);
    }

    async function loadCurrentSettings() {
        try {
            const resp = await fetch('/admin/currentsettings');
            if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
            const settings = await resp.json(); // –æ–∂–∏–¥–∞–µ–º { "notification.telegram.enabled": true/false, ... }
            const telegramCheckbox = document.getElementById('settingTelegram');
            const pachkaCheckbox = document.getElementById('settingPachka');
            if (settings['notification.telegram.enabled'] !== undefined) {
                telegramCheckbox.checked = settings['notification.telegram.enabled'];
            }
            if (settings['notification.pachka.enabled'] !== undefined) {
                pachkaCheckbox.checked = settings['notification.pachka.enabled'];
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
        }
    }

    async function changeSettings() {
        const telegramEnabled = document.getElementById('settingTelegram').checked;
        const pachkaEnabled = document.getElementById('settingPachka').checked;

        try {
            const response = await fetch('/admin/changesettings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    'notification.telegram.enabled': telegramEnabled,
                    'notification.pachka.enabled': pachkaEnabled
                })
            });

            if (response.ok) {
                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } else {
                const errorText = await response.text();
                showToast(`–û—à–∏–±–∫–∞: ${errorText}`, 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'danger');
        }
    }

    function logout() {
        window.location.href = '/';
    }
</script>
</body>
</html>